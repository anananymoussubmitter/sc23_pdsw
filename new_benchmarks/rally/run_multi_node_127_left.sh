# ES_HOSTS have the format ${IP}:9200,
ES_HOSTS="10.241.130.145:9200,10.241.130.147:9200,10.241.130.149:9200,10.241.130.151:9200,10.241.130.153:9200,10.241.130.155:9200,10.241.130.159:9200,10.241.130.161:9200,10.241.130.163:9200,10.241.130.165:9200,10.241.130.167:9200,10.241.130.169:9200,10.241.130.171:9200,10.241.130.173:9200,10.241.130.175:9200,10.241.130.177:9200,10.241.130.179:9200,10.241.130.181:9200,10.241.130.183:9200,10.241.130.185:9200,10.241.130.187:9200,10.241.130.189:9200,10.241.130.191:9200,10.241.130.241:9200,10.241.130.243:9200,10.241.130.245:9200,10.241.130.247:9200,10.241.130.249:9200,10.241.130.251:9200,10.241.130.253:9200,10.241.130.255:9200,10.241.131.1:9200,10.241.131.3:9200,10.241.131.5:9200,10.241.131.7:9200,10.241.131.9:9200,10.241.131.11:9200,10.241.131.13:9200,10.241.131.15:9200,10.241.131.17:9200,10.241.131.19:9200,10.241.131.21:9200,10.241.131.23:9200,10.241.131.25:9200,10.241.131.27:9200,10.241.131.29:9200,10.241.131.31:9200,10.241.131.81:9200,10.241.131.83:9200,10.241.131.85:9200,10.241.131.87:9200,10.241.131.89:9200,10.241.131.91:9200,10.241.131.93:9200,10.241.131.95:9200,10.241.131.97:9200,10.241.131.99:9200,10.241.131.101:9200,10.241.131.103:9200,10.241.131.105:9200,10.241.131.107:9200,10.241.131.109:9200,10.241.131.111:9200,10.241.131.113:9200,10.241.131.115:9200,10.241.131.117:9200,10.241.131.119:9200,10.241.131.121:9200,10.241.131.123:9200,10.241.131.125:9200,10.241.131.127:9200,10.241.131.177:9200,10.241.131.179:9200,10.241.131.181:9200,10.241.131.183:9200,10.241.131.185:9200,10.241.131.187:9200,10.241.131.189:9200,10.241.131.191:9200,10.241.131.193:9200,10.241.131.195:9200,10.241.131.197:9200,10.241.131.199:9200,10.241.131.201:9200,10.241.131.203:9200,10.241.131.205:9200,10.241.131.207:9200,10.241.131.209:9200,10.241.131.211:9200,10.241.131.213:9200,10.241.131.215:9200,10.241.131.217:9200,10.241.131.219:9200,10.241.131.221:9200,10.241.131.223:9200,10.241.132.17:9200,10.241.132.18:9200,10.241.132.19:9200,10.241.132.20:9200,10.241.132.21:9200,10.241.132.22:9200,10.241.132.23:9200,10.241.132.24:9200,10.241.132.25:9200,10.241.132.26:9200,10.241.132.27:9200,10.241.132.28:9200,10.241.132.29:9200,10.241.132.30:9200,10.241.132.31:9200,10.241.132.32:9200,10.241.132.33:9200,10.241.132.34:9200,10.241.132.35:9200,10.241.132.36:9200,10.241.132.37:9200,10.241.132.38:9200,10.241.132.39:9200,10.241.132.40:9200,10.241.132.41:9200,10.241.132.42:9200,10.241.132.43:9200,10.241.132.44:9200,10.241.132.45:9200,10.241.132.46:9200,10.241.132.47:9200,10.241.132.48:9200"
#ES_HOSTS="10.241.130.145:9200,10.241.130.147:9200,10.241.130.149:9200,10.241.130.151:9200,10.241.130.153:9200,10.241.130.155:9200,10.241.130.159:9200,10.241.130.161:9200,10.241.130.163:9200,10.241.130.165:9200"
# Load driver dont have ports
# IMPORTANT
# THE COORDINATOR HAS TO BE WRITTEN AS THE FIRST LOAD_DRIVER_HOST!!!
# OTHERWISE IT WILL FAIL WITH AN CRYPTIC MESSAGE
# IMPORTANT
LOAD_DRIVER_HOSTS="10.241.130.145,10.241.130.147,10.241.130.149,10.241.130.151,10.241.130.153,10.241.130.155,10.241.130.159,10.241.130.161,10.241.130.163,10.241.130.165,10.241.130.167,10.241.130.169,10.241.130.171,10.241.130.173,10.241.130.175,10.241.130.177,10.241.130.179,10.241.130.181,10.241.130.183,10.241.130.185,10.241.130.187,10.241.130.189,10.241.130.191,10.241.130.241,10.241.130.243,10.241.130.245,10.241.130.247,10.241.130.249,10.241.130.251,10.241.130.253,10.241.130.255,10.241.131.1,10.241.131.3,10.241.131.5,10.241.131.7,10.241.131.9,10.241.131.11,10.241.131.13,10.241.131.15,10.241.131.17,10.241.131.19,10.241.131.21,10.241.131.23,10.241.131.25,10.241.131.27,10.241.131.29,10.241.131.31,10.241.131.81,10.241.131.83,10.241.131.85,10.241.131.87,10.241.131.89,10.241.131.91,10.241.131.93,10.241.131.95,10.241.131.97,10.241.131.99,10.241.131.101,10.241.131.103,10.241.131.105,10.241.131.107,10.241.131.109,10.241.131.111,10.241.131.113,10.241.131.115,10.241.131.117,10.241.131.119,10.241.131.121,10.241.131.123,10.241.131.125,10.241.131.127,10.241.131.177,10.241.131.179,10.241.131.181,10.241.131.183,10.241.131.185,10.241.131.187,10.241.131.189,10.241.131.191,10.241.131.193,10.241.131.195,10.241.131.197,10.241.131.199,10.241.131.201,10.241.131.203,10.241.131.205,10.241.131.207,10.241.131.209,10.241.131.211,10.241.131.213,10.241.131.215,10.241.131.217,10.241.131.219,10.241.131.221,10.241.131.223,10.241.132.17,10.241.132.18,10.241.132.19,10.241.132.20,10.241.132.21,10.241.132.22,10.241.132.23,10.241.132.24,10.241.132.25,10.241.132.26,10.241.132.27,10.241.132.28,10.241.132.29,10.241.132.30,10.241.132.31,10.241.132.32,10.241.132.33,10.241.132.34,10.241.132.35,10.241.132.36,10.241.132.37,10.241.132.38,10.241.132.39,10.241.132.40,10.241.132.41,10.241.132.42,10.241.132.43,10.241.132.44,10.241.132.45,10.241.132.46,10.241.132.47,10.241.132.48"
#LOAD_DRIVER_HOSTS="10.241.130.145" # yes
#LOAD_DRIVER_HOSTS="10.241.130.145,10.241.130.147,10.241.130.149,10.241.130.151,10.241.130.153,10.241.130.155,10.241.130.159,10.241.130.161,10.241.130.163" # yes
#LOAD_DRIVER_HOSTS="10.241.130.145,10.241.130.147,10.241.130.149,10.241.130.151,10.241.130.153,10.241.130.155,10.241.130.159,10.241.130.161,10.241.130.163,10.241.130.165,10.241.130.167" # no
#LOAD_DRIVER_HOSTS="10.241.130.145,10.241.130.147,10.241.130.149,10.241.130.151,10.241.130.153,10.241.130.155,10.241.130.159,10.241.130.161,10.241.130.163,10.241.130.167" # no

PATH_TO_BENCHMARKS="/scratch-emmy/usr/anon/sc/new_benchmarks/rally-tracks-throughput"
PATH_TO_ESRALLY="/scratch-emmy/usr/anon/sc/Python/bin/esrally"

# just for saving path
enc_type="baseline"
# just for saving path
RESULT_FOLDER="lasttry"

# Functions
is_running() {
    while true; do
        read -p "Is an Elasticsearch already running on ${ES_HOSTS} (yes/no)? " answer
        case ${answer} in
            [Yy]* )
                echo "Starting the benchmarks..."
                break;;
            [Nn]* )
                echo "Please start the ES first..."
                exit;;
            * )
                echo "Please answer yes or no.";;
        esac
    done
}
save_race_data() {
  local benchmark_type="$1"
  local encryption_type="$2"
  local benchmark_size="$3"

  local path="./${RESULT_FOLDER}/${benchmark_type}/${encryption_type}/${benchmark_size}"
  mkdir -p "${path}"
  mv ~/.rally/benchmarks/races/* "${path}/"
}

# Prepare runs
is_running
#benchmark_types=("geonames" "nyc_taxis" "mrirally")
percentages=("10" "100")
benchmark_types=("nyc_taxis_patched_127")
#benchmark_types=("geonames")

# The actual runs
for btype in "${benchmark_types[@]}"; do
  for p in "${percentages[@]}"; do
    
    # debug just for us
    echo "$btype $p%"

    # save further metadata to collect after race
    echo $(date) > ~/.rally/benchmarks/races/before.txt
    echo $(hostname) > ~/.rally/benchmarks/races/hostname.txt
    echo $ES_HOSTS > ~/.rally/benchmarks/races/eshosts.txt
    echo $LOAD_DRIVER_HOSTS > ~/.rally/benchmarks/races/eshosts.txt

    # do the race
    ${PATH_TO_ESRALLY} race  --offline --track-path="${PATH_TO_BENCHMARKS}/${btype}" --pipeline=benchmark-only --target-hosts=${ES_HOSTS} --load-driver-hosts=${LOAD_DRIVER_HOSTS} --track-params="ingest_percentage:${p}"

    # save further metadata to collect after race
    echo $(date) > ~/.rally/benchmarks/races/after.txt

    # collect metadata, write to this directory
    save_race_data "${btype}" "${enc_type}" "${p}"

    # they sometimes kill off each other
    sleep 5
  done
done
